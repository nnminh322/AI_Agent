# 1. Định nghĩa Vùng Giới hạn Request (Rate Limit Zone)
# Chúng ta sẽ tạo một vùng tên là 'ratelimit' rộng 10MB
# để lưu trữ IP của người dùng ($binary_remote_addr).
# Tốc độ: 2 request/giây (r/s). Đây là con số ước lượng
# cho 1 model 3B trên T4 (đủ nhanh để không chặn người dùng
# bình thường, nhưng đủ chậm để chặn script spam).
limit_req_zone $binary_remote_addr zone=ratelimit:10m rate=2r/s;

# 2. Định nghĩa Upstream (Server vLLM)
upstream llm_backend {
    # Giả sử vLLM chạy trên cổng 8000 CÙNG MÁY
    server 127.0.0.1:8000;
    # (Nếu bạn scale, bạn sẽ thêm các server khác ở đây)
    # server 127.0.0.1:8001;
    # server 127.0.0.1:8002;
}

# 3. Cấu hình Server Chính
server {
    listen 80;
    server_name _; 

    # --- TÍNH NĂNG THÊM 1: Giới hạn kích thước request ---
    # Cho phép người dùng gửi prompt lớn (lên đến 10MB)
    # Tránh lỗi "413 Request Entity Too Large"
    client_max_body_size 10M;

    # --- TÍNH NĂNG THÊM 2: Bảo mật endpoint /health ---
    # Chỉ cho phép IP nội bộ (localhost) gọi /health
    # Người ngoài không thể thấy endpoint này.
    location = /health {
        allow 127.0.0.1;  # Cho phép localhost
        deny all;         # Chặn tất cả IP khác
        
        # Vẫn chuyển tiếp request đến vLLM
        proxy_pass http://llm_backend;
        proxy_set_header Host $host;
    }
    # --- BLOCK 1 : CHO PHÉP /docs ---
    # (Lưu ý: Không có API key)
    location /docs {
        proxy_pass http://llm_backend;
        proxy_set_header Host $host;
    }

    # --- BLOCK 2 : CHO PHÉP /redoc ---
    # (Lưu ý: Không có API key)
    location /redoc {
        proxy_pass http://llm_backend;
        proxy_set_header Host $host;
    }

    # --- BLOCK 3 : CHO PHÉP /openapi.json ---
    # (Lưu ý: Không có API key)
    location /openapi.json {
        proxy_pass http://llm_backend;
        proxy_set_header Host $host;
    }



    # location /chat {
        
    #     # --- REQUIREMENT 1: Rate Limiting ---
    #     # Áp dụng vùng 'ratelimit' đã định nghĩa ở trên.
    #     # burst=5: Cho phép người dùng "vượt rào" 5 request
    #     # (để trải nghiệm mượt hơn) trước khi bị bóp về 2r/s.
    #     limit_req zone=ratelimit burst=5 nodelay;

    #     # --- REQUIREMENT 2: Authentication (API Key) ---
    #     # Kiểm tra header 'X-API-Key'.
    #     # Nếu nó không tồn tại hoặc không khớp, trả về 401.
    #     if ($http_x_api_key != "nhatminh123") {
    #         return 401 "Unauthorized";
    #     }
        
    #     # --- REQUIREMENT 3: Logging IP (Forwarding) ---
    #     # Chuyển tiếp IP thật của người dùng đến FastAPI/vLLM
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header Host $host;
        
    #     # --- TÍNH NĂNG THÊM 3: Tăng Timeouts cho LLM ---
    #     # LLM có thể mất nhiều thời gian để generate
    #     # Tăng thời gian chờ lên 5 phút (300s)
    #     # Tránh lỗi "504 Gateway Time-out"
    #     proxy_connect_timeout 75s;
    #     proxy_read_timeout 300s;

    #     # Chuyển tiếp request đến vLLM
    #     proxy_pass http://llm_backend;
    # }

    location /v1/chat/completions {
        
        limit_req zone=ratelimit burst=5 nodelay;

        if ($http_x_api_key != "nhatminh123") {
            return 401 "Unauthorized";
        }
        
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        
        proxy_connect_timeout 75s;
        proxy_read_timeout 300s;

        proxy_pass http://llm_backend;
    }

}